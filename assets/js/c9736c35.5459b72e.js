"use strict";(self.webpackChunklh_site=self.webpackChunklh_site||[]).push([[423],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(n),k=r,m=c["".concat(s,".").concat(k)]||c[k]||d[k]||o;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=k;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(7294),r=n(6010);const o={tabItem:"tabItem_Ymn6"};function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o.tabItem,i),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>N});var a=n(7462),r=n(7294),o=n(6010),i=n(2466),l=n(6550),s=n(1980),u=n(7392),p=n(12);function c(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}function d(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??c(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function k(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const a=(0,l.k6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s._X)(o),(0,r.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(a.location.search);t.set(o,e),a.replace({...a.location,search:t.toString()})}),[o,a])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,o=d(e),[i,l]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!k({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[s,u]=m({queryString:n,groupId:a}),[c,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,o]=(0,p.Nk)(n);return[a,(0,r.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:a}),f=(()=>{const e=s??c;return k({value:e,tabValues:o})?e:null})();(0,r.useLayoutEffect)((()=>{f&&l(f)}),[f]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!k({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),h(e)}),[u,h,o]),tabValues:o}}var f=n(2389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function y(e){let{className:t,block:n,selectedValue:l,selectValue:s,tabValues:u}=e;const p=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.o5)(),d=e=>{const t=e.currentTarget,n=p.indexOf(t),a=u[n].value;a!==l&&(c(t),s(a))},k=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const n=p.indexOf(e.currentTarget)+1;t=p[n]??p[0];break}case"ArrowLeft":{const n=p.indexOf(e.currentTarget)-1;t=p[n]??p[p.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:i}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:e=>p.push(e),onKeyDown:k,onClick:d},i,{className:(0,o.Z)("tabs__item",g.tabItem,i?.className,{"tabs__item--active":l===t})}),n??t)})))}function b(e){let{lazy:t,children:n,selectedValue:a}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function T(e){const t=h(e);return r.createElement("div",{className:(0,o.Z)("tabs-container",g.tabList)},r.createElement(y,(0,a.Z)({},e,t)),r.createElement(b,(0,a.Z)({},e,t)))}function N(e){const t=(0,f.Z)();return r.createElement(T,(0,a.Z)({key:String(t)},e))}},6557:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>m,frontMatter:()=>l,metadata:()=>u,toc:()=>c});var a=n(7462),r=(n(7294),n(3905)),o=n(4866),i=n(5162);const l={},s="Developing Task Workers",u={unversionedId:"developer-guide/task-worker-development",id:"developer-guide/task-worker-development",title:"Developing Task Workers",description:"Each LittleHorse SDK provides an LHTaskWorker object or struct which lets you turn an arbitrary function or method into a LittleHorse Task.",source:"@site/docs/05-developer-guide/05-task-worker-development.md",sourceDirName:"05-developer-guide",slug:"/developer-guide/task-worker-development",permalink:"/littlehorse/docs/developer-guide/task-worker-development",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"LittleHorse CLI",permalink:"/littlehorse/docs/developer-guide/lhctl"},next:{title:"WfSpec Development",permalink:"/littlehorse/docs/developer-guide/wfspec-development/"}},p={},c=[{value:"Basics",id:"basics",level:2},{value:"Advanced Usage",id:"advanced-usage",level:2},{value:"Throwing Workflow <code>EXCEPTION</code>s",id:"throwing-workflow-exceptions",level:3},{value:"Json Deserialization",id:"json-deserialization",level:3},{value:"Accessing Metadata",id:"accessing-metadata",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Client ID",id:"client-id",level:3},{value:"Idempotence",id:"idempotence",level:3}],d={toc:c},k="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(k,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"developing-task-workers"},"Developing Task Workers"),(0,r.kt)("p",null,"Each LittleHorse SDK provides an ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskWorker")," object or struct which lets you turn an arbitrary function or method into a LittleHorse Task."),(0,r.kt)("h2",{id:"basics"},"Basics"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskWorker")," object allows you to create and start a Task Worker."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",default:!0,mdxType:"TabItem"},(0,r.kt)("p",null,"To create a Task Worker, you need to do the following:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create an ",(0,r.kt)("inlineCode",{parentName:"li"},"LHConfig")," (see ",(0,r.kt)("a",{parentName:"li",href:"/littlehorse/docs/developer-guide/client-configuration"},"this configuration documentation"),")."),(0,r.kt)("li",{parentName:"ol"},"Write a Task Worker class with an annotated ",(0,r.kt)("inlineCode",{parentName:"li"},"@LHTaskMethod")," method."),(0,r.kt)("li",{parentName:"ol"},"Create an ",(0,r.kt)("inlineCode",{parentName:"li"},"LHTaskWorker")," object with your config and Task Worker Object"),(0,r.kt)("li",{parentName:"ol"},"Register the ",(0,r.kt)("inlineCode",{parentName:"li"},"TaskDef")," with ",(0,r.kt)("inlineCode",{parentName:"li"},"worker.registerTaskDef()")),(0,r.kt)("li",{parentName:"ol"},"And finally call ",(0,r.kt)("inlineCode",{parentName:"li"},".start()"),".")),(0,r.kt)("p",null,"Let's build a Task Worker for a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," named ",(0,r.kt)("inlineCode",{parentName:"p"},"my-task")," that takes in a String and returns a String. First, the Task Worker Object:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'class MyWorker {\n\n    @LHTaskMethod("my-task")\n    public String doTheTask(String input) {\n        return "The input I got was: " + input;\n    }\n}\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@LHTaskMethod")," annotation tells the LH Library that ",(0,r.kt)("inlineCode",{parentName:"p"},"doTheTask")," is the method that should be called for every ",(0,r.kt)("inlineCode",{parentName:"p"},"my-task")," Task Run that is scheduled."),(0,r.kt)("p",null,"Finally, we can create an ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskWorker"),", create the ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef"),", and start the worker:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'\nMyWorker workerObject = new MyWorker();\nLHWorkerConfig config = new LHWorkerConfig();\n\nLHTaskWorker worker = new LHTaskWorker(workerObject, "my-task", config);\nworker.registerTaskDef(false);\nworker.start();\n')),(0,r.kt)("p",null,"To gracefully shutdown, you can call ",(0,r.kt)("inlineCode",{parentName:"p"},"worker.close()"),";")),(0,r.kt)(i.Z,{value:"go",label:"Go",mdxType:"TabItem"},(0,r.kt)("p",null,"To create a Task Worker, you need to do three things:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a ",(0,r.kt)("inlineCode",{parentName:"li"},"common.LHConfig")," (see ",(0,r.kt)("a",{parentName:"li",href:"/littlehorse/docs/developer-guide/client-configuration"},"this configuration documentation"),")."),(0,r.kt)("li",{parentName:"ol"},"Write a GoLang ",(0,r.kt)("inlineCode",{parentName:"li"},"func")," which you will use as your Task Function."),(0,r.kt)("li",{parentName:"ol"},"Use the ",(0,r.kt)("inlineCode",{parentName:"li"},"taskworker.NewTaskWorker()")," function to create an ",(0,r.kt)("inlineCode",{parentName:"li"},"LHTaskWorker")," with your config and Task Function.")),(0,r.kt)("p",null,"At this point, you can use your ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskWorker")," to register your ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," and to start executing tasks."),(0,r.kt)("p",null,"Let's build a Task Worker for a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," named ",(0,r.kt)("inlineCode",{parentName:"p"},"my-task")," that takes in a String and returns a String. First, the Task Function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func DoTheTask(input string) {\n    return "the input I got was: " + input\n}\n')),(0,r.kt)("p",null,"Next, we can create an ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskWorker")," and start it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'config := common.NewConfigFromEnv()\nclient, _ := common.NewLHClient(config)\n\nworker, err := tasklib.NewTaskWorker(config, DoTheTask, "my-task")\n\n// Create the TaskDef\nignoreAlreadyExists := true\nerr := worker.RegisterTaskDef(ignoreAlreadyExists)\n\n// Start Working\nworker.Start()\n'))),(0,r.kt)(i.Z,{value:"python",label:"Python",mdxType:"TabItem"},(0,r.kt)("p",null,"To create a Task Worker, you need to do the following:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create an ",(0,r.kt)("inlineCode",{parentName:"li"},"LHConfig")," (see ",(0,r.kt)("a",{parentName:"li",href:"/littlehorse/docs/developer-guide/client-configuration"},"this configuration documentation"),")."),(0,r.kt)("li",{parentName:"ol"},"Write an ",(0,r.kt)("inlineCode",{parentName:"li"},"async")," python function which you will use as your Task Function."),(0,r.kt)("li",{parentName:"ol"},"Create and start an ",(0,r.kt)("inlineCode",{parentName:"li"},"LHTaskWorker")," with that function.")),(0,r.kt)("p",null,"Here is an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'import asyncio\nimport logging\nfrom pathlib import Path\nimport random\n\nimport littlehorse\nfrom littlehorse.config import LHConfig\nfrom littlehorse.model.common_enums_pb2 import VariableType\nfrom littlehorse.worker import LHTaskWorker, WorkerContext\nfrom littlehorse.workflow import WorkflowThread, Workflow\n\nlogging.basicConfig(level=logging.INFO)\n\n\ndef get_config() -> LHConfig:\n    config = LHConfig()\n    config_path = Path.home().joinpath(".config", "littlehorse.config")\n    if config_path.exists():\n        config.load(config_path)\n    return config\n\n\ndef get_workflow() -> Workflow:\n    def my_entrypoint(thread: WorkflowThread) -> None:\n        the_name = thread.add_variable("input-name", VariableType.STR)\n        thread.execute("greet", the_name)\n\n    return Workflow("example-basic", my_entrypoint)\n\n\nasync def greeting(name: str, ctx: WorkerContext) -> str:\n    msg = f"Hello {name}!. WfRun {ctx.wf_run_id}"\n    print(msg)\n    await asyncio.sleep(random.uniform(0.5, 1.5))\n    return msg\n\n\nasync def main() -> None:\n    config = get_config()\n\n    littlehorse.create_task_def(greeting, "greet", config)\n    littlehorse.create_workflow_spec(get_workflow(), config)\n\n    await littlehorse.start(LHTaskWorker(greeting, "greet", config))\n\n\nif __name__ == "__main__":\n    asyncio.run(main())\n')))),(0,r.kt)("h2",{id:"advanced-usage"},"Advanced Usage"),(0,r.kt)("p",null,"The Task Worker library has some features that make advanced use cases easier."),(0,r.kt)("h3",{id:"throwing-workflow-exceptions"},"Throwing Workflow ",(0,r.kt)("inlineCode",{parentName:"h3"},"EXCEPTION"),"s"),(0,r.kt)("p",null,"As described in our ",(0,r.kt)("a",{parentName:"p",href:"/docs/concepts/exception-handling#business-exceptions"},"Failure Handling Concept Docs"),", LittleHorse distinguishes between technical ",(0,r.kt)("inlineCode",{parentName:"p"},"ERROR"),"s and business ",(0,r.kt)("inlineCode",{parentName:"p"},"EXCEPTION"),"s:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A technical ",(0,r.kt)("inlineCode",{parentName:"li"},"ERROR")," denotes a technological failure, such as a Timeout caused by a network outage, or an unexpected error returned by your Task Worker."),(0,r.kt)("li",{parentName:"ul"},"A Business ",(0,r.kt)("inlineCode",{parentName:"li"},"EXCEPTION")," represents an unhappy-path case in your business logic, such as when an item is out of stock or a credit card got declined.")),(0,r.kt)("p",null,"If your Task Worker throws an uncaught error (depending on your language), then it is treated as a LittleHorse ",(0,r.kt)("inlineCode",{parentName:"p"},"ERROR")," with the error code ",(0,r.kt)("inlineCode",{parentName:"p"},"LHErrorType.TASK_FAILURE"),". However, sometimes your Task Worker notices that a business process-level failure (what LittleHorse calls an ",(0,r.kt)("inlineCode",{parentName:"p"},"EXCEPTION"),") has occurred. For example, the Task Worker could notice that a credit card got declined. In this case, you can make the ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskRun")," throw a LittleHorse ",(0,r.kt)("inlineCode",{parentName:"p"},"EXCEPTION")," by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskException")," object."),(0,r.kt)("p",null,"In the following example, we will throw the ",(0,r.kt)("inlineCode",{parentName:"p"},"out-of-stock")," user-defined business ",(0,r.kt)("inlineCode",{parentName:"p"},"EXCEPTION")," if the item is out of stock."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",default:!0,mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@LHTaskMethod("ship-item")\npublic String shipItem() throws Exception {\n    if (isOutOfStock()) {\n        throw new LHTaskException("out-of-stock", "some descriptive message");\n    }\n}\n'))),(0,r.kt)(i.Z,{value:"go",label:"Go",mdxType:"TabItem"},(0,r.kt)("p",null,"The Go SDK currently (as of ",(0,r.kt)("inlineCode",{parentName:"p"},"0.7.2"),") does not yet support throwing ",(0,r.kt)("inlineCode",{parentName:"p"},"LHTaskException"),"s.")),(0,r.kt)(i.Z,{value:"python",label:"Python",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'async def ship_ite() -> None:\n    if is_out_of_stock():\n        raise LHTaskException("out-of-stock", "some descriptive message")\n')))),(0,r.kt)("h3",{id:"json-deserialization"},"Json Deserialization"),(0,r.kt)("p",null,"In some SDK's, LittleHorse will automatically deserialize JSON variables into objects or structs for you."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",default:!0,mdxType:"TabItem"},"Let's say we have a class `MyCar` as follows:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"class MyCar {\n    String make;\n    String model;\n\n    public MyCar(String make, String model) {\n        this.make = make;\n        this.model = model;\n    }\n\n    // getters, setters omitted\n}\n")),(0,r.kt)("p",null,"And one of the ",(0,r.kt)("inlineCode",{parentName:"p"},"Variable"),"s (for example, ",(0,r.kt)("inlineCode",{parentName:"p"},"my-obj"),") in our ",(0,r.kt)("inlineCode",{parentName:"p"},"WfSpec")," is of type ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON_OBJ"),"."),(0,r.kt)("p",null,"Let's say there's a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," called ",(0,r.kt)("inlineCode",{parentName:"p"},"json-example")," with one input variable of type ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON_OBJ"),". We can have a Task Worker defined as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'class MyWorker {\n\n    @LHTaskMethod("json-example")\n    public void executeTask(MyCar input) {\n        System.out.println(input.getMake());\n        System.out.println(input.getModel());\n    }\n}\n')),(0,r.kt)("p",null,"The Library will deserialize the JSON from something like: ",(0,r.kt)("inlineCode",{parentName:"p"},'{"make": "Ford", "model": "Explorer"}')," to an actual ",(0,r.kt)("inlineCode",{parentName:"p"},"MyCar")," object.")),(0,r.kt)(i.Z,{value:"go",label:"Go",mdxType:"TabItem"},"Let's say we have a struct `MyCar` as follows:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'car := &MyCar{\n    Make:  "Ford",\n    Model: "Explorer",\n}\n')),(0,r.kt)("p",null,"And one of the ",(0,r.kt)("inlineCode",{parentName:"p"},"Variable"),"s (for example, ",(0,r.kt)("inlineCode",{parentName:"p"},"my-obj"),") in our ",(0,r.kt)("inlineCode",{parentName:"p"},"WfSpec")," is of type ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON_OBJ"),"."),(0,r.kt)("p",null,"Let's say there's a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," called ",(0,r.kt)("inlineCode",{parentName:"p"},"json-example")," with one input variable of type ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON_OBJ"),". We can have a Task Function that looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func MyTaskFunc(car *MyCar) string {\n    return "the make of your car is " + car.Make + "!"\n}\n')),(0,r.kt)("p",null,"The Library will deserialize the JSON from something like: ",(0,r.kt)("inlineCode",{parentName:"p"},'{"make": "Ford", "model": "Explorer"}')," to an actual ",(0,r.kt)("inlineCode",{parentName:"p"},"MyCar")," struct.")),(0,r.kt)(i.Z,{value:"python",label:"Python",mdxType:"TabItem"},(0,r.kt)("p",null,"Let's say we have a python Task Function as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"async def describe_car(car: dict[str, Any]) -> str:\n    msg = f\"You drive a {car['brand']} model {car['model']}\"\n    return msg\n")),(0,r.kt)("p",null,"The Library will deserialize the JSON from something like: ",(0,r.kt)("inlineCode",{parentName:"p"},'{"brand": "Ford", "model": "Explorer"}')," to a python ",(0,r.kt)("inlineCode",{parentName:"p"},"dict"),"."))),(0,r.kt)("h3",{id:"accessing-metadata"},"Accessing Metadata"),(0,r.kt)("p",null,"Sometimes, your Task Worker needs to know something about where the ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskRun")," came from. Each LittleHorse SDK offers a ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext")," object or struct that exposes this metadata to the Task Worker."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",default:!0,mdxType:"TabItem"},(0,r.kt)("p",null,"If you need to access metadata about the Task Run that is being executed, you can add a ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext")," parameter to the end of your method signature for the Task Method."),(0,r.kt)("p",null,"Let's say you have a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," with one input parameter of type ",(0,r.kt)("inlineCode",{parentName:"p"},"INT"),". You can access the ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext")," by doing the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'class SomeWorker {\n\n    @LHTaskMethod("my-task")\n    public void doTask(long inputLong, WorkerContext context) {\n        String wfRunId = context.getWfRunId();\n        TaskRunId taskRunId = context.getTaskRunId();\n        NodeRunId nodeRunId = context.getNodeRunId();\n\n        Date timeWhenTaskWasScheduled = context.getScheduledTime();\n\n        context.log(\n            "This is a message that gets sent to the log output on the scheduler"\\\n        );\n\n        int attemptNumber = context.getAttemptNumber();\n        if (attemptNumber == 0) {\n            // then this is the first time this Task Run has been attempted.\n        } else {\n            // then this is a retry.\n        }\n\n        // This is a constant value between all attempts for this TaskRun.\n        // Useful to allow retries to third-party API\'s that accept idempotency\n        // keys, such as Stripe.\n        String idempotencyKey = context.getIdempotencyKey();\n    }\n}\n'))),(0,r.kt)(i.Z,{value:"go",label:"Go",mdxType:"TabItem"},(0,r.kt)("p",null,"If you need to access metadata about the Task Run that is being executed, you can add a ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext")," parameter to the end of your method signature for the Task Method."),(0,r.kt)("p",null,"Let's say you have a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," with one input parameter of type ",(0,r.kt)("inlineCode",{parentName:"p"},"INT"),". You can access the ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext")," by doing the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func DoTask(long inputLong, context *common.WorkerContext) {\n    wfRunId := context.GetWfRunId();\n    taskRunId := context.GetTaskRunId();\n    nodeRunId := context.GetNodeRunId();\n\n    timeWhenTaskWasScheduled := context.GetScheduledTime();\n\n    context.Log(\n        "This is a message that gets sent to the log output on the scheduler",\n    );\n\n    attemptNumber := context.GetAttemptNumber();\n    if (attemptNumber == 0) {\n        // then this is the first time this Task Run has been attempted.\n    } else {\n        // then this is a retry.\n    }\n\n    idempotencyKey := context.GetIdempotencyKey();\n}\n'))),(0,r.kt)(i.Z,{value:"python",label:"Python",mdxType:"TabItem"},(0,r.kt)("p",null,"If you need to access metadata about the Task Run that is being executed, you can add an ",(0,r.kt)("inlineCode",{parentName:"p"},"LHWorkerContext")," parameter to the end of your method signature for the Task Method."),(0,r.kt)("p",null,"Let's say you have a ",(0,r.kt)("inlineCode",{parentName:"p"},"TaskDef")," with one input parameter of type ",(0,r.kt)("inlineCode",{parentName:"p"},"INT"),". You can access the ",(0,r.kt)("inlineCode",{parentName:"p"},"LHWorkerContext")," by doing the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'\nasync def greeting(name: str, ctx: LHWorkerContext) -> str:\n    task_run_id = ctx.task_run_id\n    node_run_id = ctx.node_run_id\n    wf_run_id = ctx.node_run_id\n\n    time_task_was_scheduled = ctx.scheduled_time\n\n    attempt_number = ctx.attempt_number\n    if attempt_number > 0:\n        # this is a retry\n        pass\n    else:\n        # this is not a retry\n        pass\n    \n    idempotency_key = ctx.idempotency_key\n    return "asdf"\n\n')))),(0,r.kt)("h2",{id:"best-practices"},"Best Practices"),(0,r.kt)("h3",{id:"client-id"},"Client ID"),(0,r.kt)("p",null,"Every Task Worker instance should have a unique ",(0,r.kt)("inlineCode",{parentName:"p"},"LHC_CLIENT_ID")," set in its configuration. This is important so that you can audit which client executed which Task, and also so that the LH Server can efficiently assign partitions of work to your Task Workers."),(0,r.kt)("h3",{id:"idempotence"},"Idempotence"),(0,r.kt)("p",null,"With all workflow engines, it is best when your tasks are idempotent. You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"NodeRunIdPb")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"WorkerContext::getNodeRunId()")," as an idempotency key."))}m.isMDXComponent=!0}}]);