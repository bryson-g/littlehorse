"use strict";(self.webpackChunklh_site=self.webpackChunklh_site||[]).push([[832],{635:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var r=n(4848),s=n(8453),a=n(1470),o=n(9365);const i={},l="Background",c={id:"developer-guide/grpc/basics",title:"Background",description:"The public LittleHorse API is a GRPC service exposed by the LH Server. We plan to add auto-generated GRPC documentation soon (i.e. before the upcoming release of 1.0.0). In the meantime, you can find our service defined in our source code.",source:"@site/docs/05-developer-guide/09-grpc/00-basics.md",sourceDirName:"05-developer-guide/09-grpc",slug:"/developer-guide/grpc/basics",permalink:"/docs/developer-guide/grpc/basics",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:0,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Using the LittleHorse API",permalink:"/docs/developer-guide/grpc/"},next:{title:"Managing Metadata",permalink:"/docs/developer-guide/grpc/managing-metadata"}},u={},d=[{value:"Error Handling",id:"error-handling",level:2},{value:"Read-Only Requests and Mutating Requests",id:"read-only-requests-and-mutating-requests",level:2},{value:"List and Search",id:"list-and-search",level:2},{value:"What is an LH API Object?",id:"what-is-an-lh-api-object",level:3},{value:"Pagination",id:"pagination",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"background",children:"Background"}),"\n",(0,r.jsxs)(t.p,{children:["The public LittleHorse API is a GRPC service exposed by the LH Server. We plan to add auto-generated GRPC documentation soon (i.e. before the upcoming release of ",(0,r.jsx)(t.code,{children:"1.0.0"}),"). In the meantime, you can find our service defined in our ",(0,r.jsx)(t.a,{href:"https://github.com/littlehorse-enterprises/littlehorse/schemas/service.proto",children:"source code"}),"."]}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsxs)(t.p,{children:["For background, we would recommend checking out the GRPC documentation for a primer on GRPC in ",(0,r.jsx)(t.a,{href:"https://grpc.io/docs/languages/java/",children:"Java"}),", ",(0,r.jsx)(t.a,{href:"https://grpc.io/docs/languages/go/",children:"Go"}),", and ",(0,r.jsx)(t.a,{href:"https://grpc.io/docs/languages/python/",children:"Python"}),"."]})}),"\n",(0,r.jsxs)(t.p,{children:["Because the public LittleHorse API is a GRPC service, you may notice that the ",(0,r.jsx)(t.code,{children:"LHConfig"})," object in all three of our SDK's has a ",(0,r.jsx)(t.code,{children:"getStub()"})," method or equivalent. This returns the autogenerated GRPC client in the appropriate language."]}),"\n",(0,r.jsx)(t.p,{children:"This page describes several patterns in the LittleHorse API. Some of these patterns come directly from GRPC (such as error handling and status codes), and others such as our implementation of cursor-based pagination are specific to LittleHorse."}),"\n",(0,r.jsx)(t.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsxs)(t.p,{children:["The LittleHorse API uses the standard GRPC Error Codes, and we strictly follow the conventions described in ",(0,r.jsx)(t.a,{href:"https://grpc.github.io/grpc/core/md_doc_statuscodes.html",children:"the official documentation"}),". The most common error codes you will encounter are ",(0,r.jsx)(t.code,{children:"NOT_FOUND"}),", ",(0,r.jsx)(t.code,{children:"FAILED_PRECONDITION"}),", ",(0,r.jsx)(t.code,{children:"ALREADY_EXISTS"}),", and ",(0,r.jsx)(t.code,{children:"INVALID_ARGUMENT"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["When handling errors from the LittleHorse API, you should treat the status code as a machine-readable signal, and the error-message should be treated as a ",(0,r.jsx)(t.em,{children:"human-readable"})," debugging aid. Your control flow logic should not depend on the content of the error message; it should only pay attention to the error status code."]}),"\n",(0,r.jsxs)(t.p,{children:["LittleHorse ",(0,r.jsx)(t.strong,{children:"currently"})," does not utilize the GRPC Trailers to send error content in the form of a well-formed protobuf message."]}),"\n",(0,r.jsxs)(t.p,{children:["In the example below, we will make a ",(0,r.jsx)(t.code,{children:"RunWf"})," request and provide the ",(0,r.jsx)(t.code,{children:"id"})," of the ",(0,r.jsx)(t.code,{children:"WfRun"})," which we want to run. Such a request will fail with an ",(0,r.jsx)(t.code,{children:"ALREADY_EXISTS"})," error if the ",(0,r.jsx)(t.code,{children:"WfRun"})," already exists. The example below will show you how to catch such an error."]}),"\n",(0,r.jsxs)(a.A,{children:[(0,r.jsx)(o.A,{value:"java",label:"Java",default:!0,children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",children:'import io.grpc.StatusRuntimeException; // GRPC propagates errors through this exception.\nimport io.grpc.Status.Code; // This is the proper enum for handling responses. NOTE: it is\n                            // different than the enum used for **throwing** errors on the\n                            // server side.\n\nLittleHorseBlockingStub client = ...;\nString wfRunId = "obi-wan-workflow-run-id";\n\ntry {\n    client.runWf(RunWfRequest.newBuilder()\n            .setWfSpecName("example-run-wf")\n            .putVariables("n", LHLibUtil.objToVarVal(n))\n            .build()\n    );\n} catch (StatusRuntimeException exn) {\n    if (exn.getStatus().getCode() == Code.ALREADY_EXISTS) {\n        System.out.println("Request failed because WfRun with this ID already exists!");\n    } else {\n        System.out.println("Yikes, we got a different error.");\n        throw exn;\n    }\n}\n'})})}),(0,r.jsx)(o.A,{value:"go",label:"Go",children:(0,r.jsx)(t.p,{children:"Go example coming soon. However, it should be highly similar to the Java example above."})}),(0,r.jsx)(o.A,{value:"python",label:"Python",children:(0,r.jsx)(t.p,{children:"Python example coming soon. However, it should be highly similar to the Java example above."})})]}),"\n",(0,r.jsx)(t.h2,{id:"read-only-requests-and-mutating-requests",children:"Read-Only Requests and Mutating Requests"}),"\n",(0,r.jsx)(t.p,{children:"In LittleHorse, there are two predominant types of GRPC requests:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Read-Only Requests, which simply returns information about the current state of the system without altering it (eg. get a ",(0,r.jsx)(t.code,{children:"WfRun"})," via the ",(0,r.jsx)(t.code,{children:"rpc GetWfRun"}),"), and"]}),"\n",(0,r.jsxs)(t.li,{children:["Mutating Requests, which may alter the state of the system (eg. run a ",(0,r.jsx)(t.code,{children:"WfRun"})," via the ",(0,r.jsx)(t.code,{children:"rpc RunWf"}),")."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["In LittleHorse, all Read-Only Requests (with the exception of ",(0,r.jsx)(t.code,{children:"rpc Whoami"}),") start with ",(0,r.jsx)(t.code,{children:"Get"}),", ",(0,r.jsx)(t.code,{children:"List"}),", or ",(0,r.jsx)(t.code,{children:"Search"}),". Any other request is a Mutating Request."]}),"\n",(0,r.jsxs)(t.p,{children:["All Mutating Requests in LittleHorse ",(0,r.jsx)(t.em,{children:"can be"})," made idempotent if you pass in the proper information. For example, if you pass in the ",(0,r.jsx)(t.code,{children:"id"})," field on the ",(0,r.jsx)(t.code,{children:"rpc RunWf"}),", you can safely retry the request multiple times and only one ",(0,r.jsx)(t.code,{children:"WfRun"})," will be created. For"]}),"\n",(0,r.jsx)(t.h2,{id:"list-and-search",children:"List and Search"}),"\n",(0,r.jsxs)(t.p,{children:["List Requests and Search Requests are highly similar, with one distinct difference: a ",(0,r.jsx)(t.em,{children:"List Request"})," returns a series of ",(0,r.jsx)(t.em,{children:"objects"}),", whereas a Search Request returns a series of ",(0,r.jsx)(t.em,{children:"object id's"}),". For example, the ",(0,r.jsx)(t.code,{children:"rpc ListTaskRun"})," returns a ",(0,r.jsx)(t.code,{children:"TaskRunList"})," (list of ",(0,r.jsx)(t.code,{children:"TaskRun"}),"'s) whereas the ",(0,r.jsx)(t.code,{children:"rpc SearchTaskRun"})," returns a ",(0,r.jsx)(t.code,{children:"TaskRunIdList"})," (list of ",(0,r.jsx)(t.code,{children:"TaskRunId"}),"'s)."]}),"\n",(0,r.jsxs)(t.p,{children:["Generally, List Requests list all objects of a certain type belonging to a specific ",(0,r.jsx)(t.code,{children:"WfRun"}),", but that is an observation and not a rule."]}),"\n",(0,r.jsx)(t.h3,{id:"what-is-an-lh-api-object",children:"What is an LH API Object?"}),"\n",(0,r.jsxs)(t.p,{children:["Something that is stored in the LittleHorse Data Store and can be retrieved through some request ",(0,r.jsx)(t.code,{children:"rpc GetFoo"}),' in the LittleHorse API is refered to as a "LittleHorse API Object". Some common types of LH Api Objects are ',(0,r.jsx)(t.code,{children:"WfRun"}),", ",(0,r.jsx)(t.code,{children:"WfSpec"}),", ",(0,r.jsx)(t.code,{children:"TaskRun"}),", and ",(0,r.jsx)(t.code,{children:"TaskDef"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:['An "Object Id" is a unique identifier for an LH API Object and contains all of the necessary information required to retrieve the LH API Object from the API via a request ',(0,r.jsx)(t.code,{children:"rpc GetFoo"}),", such as: ",(0,r.jsx)(t.code,{children:"rpc GetWfRun"}),", ",(0,r.jsx)(t.code,{children:"rpc GetWfSpec"}),", ",(0,r.jsx)(t.code,{children:"rpc GetTaskRun"}),", and ",(0,r.jsx)(t.code,{children:"rpc GetTaskDef"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["For a given LH API Object Type (in this example, ",(0,r.jsx)(t.code,{children:"TaskRun"}),"), it is common to have some or all of the following requests:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-protobuf",children:"message TaskRunId {\n    WfRunId wf_run_id = 1;\n    string guid = 2;\n}\n\nmessage TaskRunIdList {\n    repeated TaskRunId results = 1;\n    optional bytes bookmark = 2; // for cursor-based pagination\n}\n\nmessage TaskRunList {\n    repeated TaskRun results = 1;\n    optional bytes bookmark = 2; // for cursor-based pagination\n}\n\n// ...\nservice LittleHorse {\n    // ...\n    rpc GetTaskRun(TaskRunId) returns(TaskRun) {}\n    rpc ListTaskRun(ListTaskRunRequest) returns (TaskRunList) {}\n    rpc SearchTaskRun(SearchTaskRunRequest) returns (TaskRunIdList) {}\n}\n"})}),"\n",(0,r.jsx)(t.h3,{id:"pagination",children:"Pagination"}),"\n",(0,r.jsxs)(t.p,{children:["Both List Requests and Search Requests alike use ",(0,r.jsx)(t.a,{href:"https://slack.engineering/evolving-api-pagination-at-slack/",children:"Cursor-Based Pagination"}),". For an example, we will look at the ",(0,r.jsx)(t.code,{children:"rpc SearchTaskRun"}),". Note the ",(0,r.jsx)(t.code,{children:"optiona bytes bookmark"})," field and the ",(0,r.jsx)(t.code,{children:"optional int32 limit"})," field."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-proto",children:"// Searches for TaskRuns by various criteria.\nmessage SearchTaskRunRequest {\n    optional bytes bookmark = 1;\n    optional int32 limit = 2;\n    string task_def_name = 3;\n    optional TaskStatus status = 4;\n    optional google.protobuf.Timestamp earliest_start = 5;\n    optional google.protobuf.Timestamp latest_start = 6;\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"limit"})," field determines the maximum number of results to be returned in a single request."]}),"\n",(0,r.jsxs)(t.p,{children:["Recall the ",(0,r.jsx)(t.code,{children:"optional bytes bookmark"})," field in the ",(0,r.jsx)(t.code,{children:"TaskRunIdList"})," proto. The ",(0,r.jsx)(t.code,{children:"TaskRunIdList"})," is the response format for the request ",(0,r.jsx)(t.code,{children:"rpc SearchTaskRun"}),". If the ",(0,r.jsx)(t.code,{children:"rpc SearchTaskRun"})," has more results than can be returned in one request (see ",(0,r.jsx)(t.code,{children:"limit"}),"), then the ",(0,r.jsx)(t.code,{children:"bookmark"})," field of the ",(0,r.jsx)(t.code,{children:"TaskRunIdList"})," message is set to a byte-string that serves as a ",(0,r.jsx)(t.em,{children:"cursor"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["To retrieve the next page of results, simply pass in the ",(0,r.jsx)(t.code,{children:"bookmark"})," from your previous request to your next request. An example of iterating through pages of results is shown below."]}),"\n",(0,r.jsxs)(a.A,{children:[(0,r.jsx)(o.A,{value:"java",label:"Java",default:!0,children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",children:'import io.littlehorse.sdk.common.proto.SearchTaskRunRequest;\nimport io.littlehorse.sdk.common.proto.TaskRunIdList;\n\nTaskRunIdList results = client.searchTaskRun(SearchTaskRunRequest.newBuilder()\n        .setTaskDefName("my-task")\n        .setLimit(5)\n        .build());\n// Omitted: process the TaskRunId\'s in `results.getResultsList()`.\n\nwhile (results.hasBookmark()) {\n    results = client.searchTaskRun(SearchTaskRunRequest.newBuilder()\n            .setTaskDefName("my-task")\n            .setLimit(5)\n            .setBookmark(results.getBookmark())\n            .build());\n    // Omitted: process the TaskRunId\'s in results.getResultsList();\n}\n'})})}),(0,r.jsx)(o.A,{value:"go",label:"Go",children:(0,r.jsx)(t.p,{children:"Go example coming soon. However, it should be highly similar to the Java example above."})}),(0,r.jsx)(o.A,{value:"python",label:"Python",children:(0,r.jsx)(t.p,{children:"Python example coming soon. However, it should be highly similar to the Java example above."})})]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},9365:(e,t,n)=>{n.d(t,{A:()=>o});n(6540);var r=n(8215);const s={tabItem:"tabItem_Ymn6"};var a=n(4848);function o(e){let{children:t,hidden:n,className:o}=e;return(0,a.jsx)("div",{role:"tabpanel",className:(0,r.A)(s.tabItem,o),hidden:n,children:t})}},1470:(e,t,n)=>{n.d(t,{A:()=>k});var r=n(6540),s=n(8215),a=n(3104),o=n(6347),i=n(205),l=n(7485),c=n(1682),u=n(9466);function d(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??function(e){return d(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:s}}=e;return{value:t,label:n,attributes:r,default:s}}))}(n);return function(e){const t=(0,c.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function p(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const s=(0,o.W6)(),a=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l.aZ)(a),(0,r.useCallback)((e=>{if(!a)return;const t=new URLSearchParams(s.location.search);t.set(a,e),s.replace({...s.location,search:t.toString()})}),[a,s])]}function f(e){const{defaultValue:t,queryString:n=!1,groupId:s}=e,a=h(e),[o,l]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!p({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:a}))),[c,d]=m({queryString:n,groupId:s}),[f,g]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[s,a]=(0,u.Dv)(n);return[s,(0,r.useCallback)((e=>{n&&a.set(e)}),[n,a])]}({groupId:s}),x=(()=>{const e=c??f;return p({value:e,tabValues:a})?e:null})();(0,i.A)((()=>{x&&l(x)}),[x]);return{selectedValue:o,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),g(e)}),[d,g,a]),tabValues:a}}var g=n(2303);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=n(4848);function j(e){let{className:t,block:n,selectedValue:r,selectValue:o,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),u=e=>{const t=e.currentTarget,n=l.indexOf(t),s=i[n].value;s!==r&&(c(t),o(s))},d=e=>{let t=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const n=l.indexOf(e.currentTarget)+1;t=l[n]??l[0];break}case"ArrowLeft":{const n=l.indexOf(e.currentTarget)-1;t=l[n]??l[l.length-1];break}}t?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},t),children:i.map((e=>{let{value:t,label:n,attributes:a}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:r===t?0:-1,"aria-selected":r===t,ref:e=>l.push(e),onKeyDown:d,onClick:u,...a,className:(0,s.A)("tabs__item",x.tabItem,a?.className,{"tabs__item--active":r===t}),children:n??t},t)}))})}function v(e){let{lazy:t,children:n,selectedValue:s}=e;const a=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=a.find((e=>e.props.value===s));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:a.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==s})))})}function R(e){const t=f(e);return(0,b.jsxs)("div",{className:(0,s.A)("tabs-container",x.tabList),children:[(0,b.jsx)(j,{...t,...e}),(0,b.jsx)(v,{...t,...e})]})}function k(e){const t=(0,g.A)();return(0,b.jsx)(R,{...e,children:d(e.children)},String(t))}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>i});var r=n(6540);const s={},a=r.createContext(s);function o(e){const t=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:t},e.children)}}}]);